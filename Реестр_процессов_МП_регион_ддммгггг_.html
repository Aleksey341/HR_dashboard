<!DOCTYPE html>
<html lang="ru" class="scroll-smooth">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>–§–æ—Ä–º–∞ –æ–ø—Ä–æ—Å–∞ v3.2 (–°–±—Ä–æ—Å –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', 
                        accent: '#2563eb',  
                        background: '#f9fafb', 
                        card: '#ffffff',      
                        tooltip: '#eef4ff',   
                        danger: '#ef4444',    
                    },
                    boxShadow: {
                        soft: '0 4px 12px rgba(0,0,0,0.1)'
                    },
                    borderRadius: {
                        xl2: '1rem'
                    },
                    ringOffsetWidth: { '2': '2px', },
                    ringColor: { DEFAULT: '#3b82f6', }
                }
            }
        }
    </script>
    <style>
        .glossary-list dt { font-weight: 600; margin-top: 0.75rem; color: #374151; }
		/* Chrome, Safari, Edge */
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* Firefox */
input[type="number"] {
  -moz-appearance: textfield;
}

        .dark .glossary-list dt { color: #d1d5db; }
        .glossary-list dd { margin-left: 1rem; margin-top: 0.25rem; font-size: 0.875rem; color: #4b5563; }
        .dark .glossary-list dd { color: #9ca3af; }
        .button-loading::after { content: ""; display: inline-block; width: 1em; height: 1em; margin-left: 0.5em; vertical-align: -0.125em; border: 2px solid currentColor; border-left-color: transparent; border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .field-error { border-color: #ef4444 !important; --tw-ring-color: #ef4444 !important; }
        .label-error { color: #ef4444 !important; }
    </style>
</head>
<body class="font-sans bg-background text-gray-800 dark:bg-gray-900 dark:text-gray-100">
    <header class="bg-gradient-to-r from-gray-900 to-blue-900 text-white py-2 px-4 flex flex-col sm:flex-row justify-between items-center shadow-md sticky top-0 z-40">
        <div class="flex items-center space-x-4 mb-2 sm:mb-0">
            <span class="bg-white text-black uppercase px-3 py-1 rounded-full font-semibold text-sm">—Ä–æ—Å–º–æ–ª–æ–¥—ë–∂—å</span>
            <span class="text-xs leading-tight text-center sm:text-left">–ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ<br>–õ–∏–ø–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏</span>
        </div>
        <div class="flex items-center space-x-2 sm:space-x-4">
            <button id="clearStorageBtn" aria-label="–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ (–æ—á–∏—Å—Ç–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)" class="p-2 focus:outline-none text-xl hover:bg-white/10 rounded-full" title="–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ (–æ—á–∏—Å—Ç–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)">üîÑ</button>
            <button id="themeToggle" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É" class="p-2 focus:outline-none text-xl hover:bg-white/10 rounded-full">üåô</button>
            <div class="text-xs text-center sm:text-right">–ê–ù–û "–û–±–ª–∞—Å—Ç—å –±—É–¥—É—â–µ–≥–æ"</div>
        </div>
    </header>

    <main class="max-w-3xl mx-auto p-4">
        <div id="progressBar" class="flex justify-center space-x-1 sm:space-x-2 mb-6 overflow-x-auto pb-2"></div>
        <h2 id="stepTitle" class="text-2xl font-bold text-center text-accent dark:text-primary mb-4"></h2>
        <div id="navigation-buttons-top" class="flex flex-col sm:flex-row justify-between items-center mb-6"> 
            <button id="prevBtn" class="w-full sm:w-auto px-6 py-3 bg-gray-400 text-white rounded-xl2 shadow-soft hover:bg-gray-500 disabled:opacity-50 disabled:cursor-not-allowed mb-2 sm:mb-0 transition-colors duration-150" disabled>‚Üê –ù–∞–∑–∞–¥</button>
            <div class="w-full sm:w-auto flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                <button id="nextBtn" class="w-full sm:w-auto px-6 py-3 bg-primary text-white rounded-xl2 shadow-soft hover:bg-accent disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150">–î–∞–ª–µ–µ ‚Üí</button>
                <button id="exportBtn" class="w-full sm:w-auto px-6 py-3 bg-green-500 text-white rounded-xl2 shadow-soft hover:bg-green-600 hidden transition-colors duration-150">–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
            </div>
        </div>
        <div id="stepDefinitionContainer"></div>
        <section id="formSteps" class="space-y-6"></section>
        <!--
<p id="counterDisplay" class="mt-4 text-center text-sm text-gray-600 dark:text-gray-400"></p>
-->

        <div id="email-block" class="hidden mt-6 p-4 bg-card dark:bg-gray-800 rounded-xl2 shadow-soft border border-gray-200 dark:border-gray-700 text-center">
            <p class="text-gray-700 dark:text-gray-300">–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π —Ñ–∞–π–ª Excel –≤ —Å–≤–æ—é –≤–µ—Ç–∫—É —á–∞—Ç–∞ Telegram</p>
            <div class="mt-2">
                <span id="email-text" class="font-mono text-primary dark:text-blue-400 break-all"></span>
                <!--
<button onclick="copyEmail()" class="ml-0 mt-2 sm:ml-4 sm:mt-0 px-4 py-2 bg-accent text-white rounded-xl2 hover:bg-primary transition-colors duration-150 text-sm">
  –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å Email
</button>
-->

            </div>
        </div>
    </main>
    <div id="toastContainer" class="fixed bottom-6 right-6 space-y-2 z-50 w-full max-w-xs sm:max-w-sm"></div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <script>
        const STEP_GLOSSARY = 0;
        const STEP_INSTRUCTIONS = 1;
        const STEP_PERSONAL_DATA = 2;
        const STEP_PROCESS_MAIN_INFO = 3;
        const STEP_RELATED_PROCESSES = 4; 
        const STEP_CUSTOMER_BENEFICIARY = 5;
        const STEP_DOCS_RESULTS_KPI = 6;
        const STEP_REPORTS = 7;
        const STEP_WORKFLOW_TECH = 8;

        const stepsData = [
            { 
                icon: "üìö",
                title: "–ì–ª–æ—Å—Å–∞—Ä–∏–π —Ç–µ—Ä–º–∏–Ω–æ–≤",
                fields: [],
                stepDefinitionHtml: `
                    <div class="prose dark:prose-invert max-w-none">
                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-3">–ì–ª–æ—Å—Å–∞—Ä–∏–π —Ç–µ—Ä–º–∏–Ω–æ–≤</h3>
                        <dl class="glossary-list">
                            <dt>–ü—Ä–æ—Ü–µ—Å—Å</dt>
                            <dd>–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –∏–ª–∏ —à–∞–≥–æ–≤, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞, —É—Å–ª—É–≥–∏ –∏–ª–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ —Ä–∞–º–∫–∞—Ö –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏–ª–∏ –æ—Ä–≥–∞–Ω–∞ –≤–ª–∞—Å—Ç–∏.</dd>
                            <dt>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</dt>
                            <dd>–û—Ç–¥–µ–ª—å–Ω–æ–µ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–ª–∏ —Å–æ–≤–æ–∫—É–ø–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π, –ø—Ä–æ–≤–æ–¥–∏–º—ã—Ö –≤ —Ä–∞–º–∫–∞—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ü–µ–ª–∏ –∏–ª–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–≤–µ—â–∞–Ω–∏–µ, –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è, –ø—Ä–æ–≤–µ—Ä–∫–∞, —É—á–µ–±–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ –∏ —Ç.–ø.). </dd>
                            <dt>–°–≤—è–∑–∞–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å</dt>
                            <dd>–≠—Ç–æ –¥—Ä—É–≥–æ–π –ø—Ä–æ—Ü–µ—Å—Å, –∫–æ—Ç–æ—Ä—ã–π –∏–º–µ–µ—Ç –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω—É—é –≤–∑–∞–∏–º–æ—Å–≤—è–∑—å –∏–ª–∏ –≤–∑–∞–∏–º–æ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å —Å —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º—ã–º (–æ—Å–Ω–æ–≤–Ω—ã–º) –ø—Ä–æ—Ü–µ—Å—Å–æ–º. </dd>
                            <dt>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –ø—Ä–æ—Ü–µ—Å—Å–∞</dt>
                            <dd>–†–æ–ª—å –∏–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –ø—Ä–æ—Ü–µ—Å—Å–∞. –í –¥–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è –≤—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤. </dd>
                            <dt>–ë–ª–∞–≥–æ–ø–æ–ª—É—á–∞—Ç–µ–ª—å –ø—Ä–æ—Ü–µ—Å—Å–∞</dt>
                            <dd>–ö–æ–Ω–µ—á–Ω—ã–π –ø–æ–ª—É—á–∞—Ç–µ–ª—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞. </dd>
                            <dt>–ò–Ω–∏—Ü–∏–∏—Ä—É—é—â–µ–µ —Å–æ–±—ã—Ç–∏–µ</dt>
                            <dd>–≠—Ç–æ —Å–≤–µ–¥–µ–Ω–∏—è –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞.</dd>
                            <dt>–†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ –≤—ã—Ö–æ–¥–µ</dt>
                            <dd>–≠—Ç–æ –≤—ã–≥–æ–¥–∞ –∏–ª–∏ —Ü–µ–Ω–Ω–æ—Å—Ç—å, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—É—á–∞—é—Ç—Å—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞.</dd>
                            <dt>–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã</dt>
                            <dd>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏—è –∏–ª–∏ –º–µ—Ö–∞–Ω–∏–∑–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏, —Å–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ç–∞–¥–∏—è—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥).</dd>
                            <dt>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</dt>
                            <dd>–≠—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º, –ø–ª–∞—Ç—Ñ–æ—Ä–º –∏–ª–∏ —Å–µ—Ä–≤–∏—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –¥–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞.</dd>
                            <dt>–ú–∞–∫—Ä–æ—Å</dt>
                            <dd>–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥ –∏–ª–∏ –¥–µ–π—Å—Ç–≤–∏–π, –∑–∞–ø–∏—Å–∞–Ω–Ω–∞—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –∑–∞–¥–∞—á –≤ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ. –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤ –∑–∞ –æ–¥–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ, —É–ø—Ä–æ—â–∞—è —Ä—É—Ç–∏–Ω–Ω—É—é —Ä–∞–±–æ—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏ –∏–ª–∏ —Ç–µ–∫—Å—Ç–∞–º–∏).</dd>
                            <dt>–†–æ–±–æ—Ç–∏–∑–∞—Ü–∏—è (RPA)</dt>
                            <dd>–≠—Ç–æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è, –∫–æ—Ç–æ—Ä–∞—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ (–Ω–∞–∑—ã–≤–∞–µ–º–æ–µ "—Ä–æ–±–æ—Ç–∞–º–∏"), —Å–ø–æ—Å–æ–±–Ω–æ–µ –∏–º–∏—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏—è —á–µ–ª–æ–≤–µ–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–º –∏ —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Ü–∏—Ñ—Ä–æ–≤—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏.</dd>
                            <dt>–ò—Å–∫—É—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç (–ò–ò)</dt>
                            <dd>–≠—Ç–æ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –≤—ã–ø–æ–ª–Ω—è—Ç—å –∑–∞–¥–∞—á–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ —Ç—Ä–µ–±—É—é—Ç —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–≥–æ —É–º–∞. –ö —Ç–∞–∫–∏–º –∑–∞–¥–∞—á–∞–º –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –æ–±—É—á–µ–Ω–∏–µ, —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –ø—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏–π –∏ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º.</dd>
                        </dl>
                    </div>
                `
            },
            { 
                icon: "üìù",
                title: "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é",
                fields: [],
                stepDefinitionHtml: `
                    <div class="prose dark:prose-invert max-w-none">
                        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-3">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é</h3>
                        <ol class="list-decimal list-inside space-y-2 text-gray-700 dark:text-gray-300">
                            <li>–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –æ–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è–º–∏ —Ç–µ—Ä–º–∏–Ω–æ–≤ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —à–∞–≥–µ.</li>
                            <li>–î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–î–∞–ª–µ–µ ‚Üí". –î–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —à–∞–≥—É ‚Äî "‚Üê –ù–∞–∑–∞–¥".</li>
                            <li>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –Ω–∞ —Ç–µ–∫—É—â–µ–º —à–∞–≥–µ. –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –≤—Å–µ –≤–∏–¥–∏–º—ã–µ –ø–æ–ª—è. –ü–æ–ª—è, –æ–∂–∏–¥–∞—é—â–∏–µ —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –ø—Ä–∏–Ω–∏–º–∞—é—Ç —Ç–æ–ª—å–∫–æ –Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —Ü–∏—Ñ—Ä—ã.</li>
                            <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–∫–æ–Ω–∫—É (‚ÑπÔ∏è) —Ä—è–¥–æ–º —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –ø–æ–ª—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –∫–ª–∞–≤–∏—à—É 'Escape' (–∫–æ–≥–¥–∞ –∏–∫–æ–Ω–∫–∞ –≤ —Ñ–æ–∫—É—Å–µ), —á—Ç–æ–±—ã —Å–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É.</li>
                            <li>–í–∏–¥–∏–º–æ—Å—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–ª–µ–π –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–∞—à–µ–≥–æ –≤—ã–±–æ—Ä–∞ –≤ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –ø–æ–ª—è—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π).</li>
                            <li>–®–∞–≥ "–°–≤—è–∑–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã" —è–≤–ª—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º. –°–Ω–∞—á–∞–ª–∞ –æ—Ç–≤–µ—Ç—å—Ç–µ, –µ—Å—Ç—å –ª–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã. –ï—Å–ª–∏ "–î–∞", –≤—ã —Å–º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ 5 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.</li>
                            <li>–ù–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–º —à–∞–≥–µ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø—Ä–æ—Ü–µ—Å—Å—É (—à–∞–≥ "–î–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏") –∫–Ω–æ–ø–∫–∞ "–î–∞–ª–µ–µ ‚Üí" –∏–∑–º–µ–Ω–∏—Ç—Å—è –Ω–∞ "–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å". –ù–∞–∂–º–∏—Ç–µ –µ–µ, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å –∏ –Ω–∞—á–∞—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ. –ü–æ–ª—è "–†–µ–≥–∏–æ–Ω" –∏ "–§–ò–û –∑–∞–ø–æ–ª–Ω—è—é—â–µ–≥–æ" –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.</li>
                            <li>–ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –∫–Ω–æ–ø–∫–∞ "–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel" —Å—Ç–∞–Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–∞ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–º —à–∞–≥–µ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö. –ù–∞–∂–º–∏—Ç–µ –µ–µ, —á—Ç–æ–±—ã —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª —Å–æ –≤—Å–µ–º–∏ –≤–≤–µ–¥–µ–Ω–Ω—ã–º–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏ (–≤–∫–ª—é—á–∞—è —Ç–µ–∫—É—â–∏–π, –µ—Å–ª–∏ –æ–Ω –∑–∞–ø–æ–ª–Ω–µ–Ω –∏ –≤–∞–ª–∏–¥–µ–Ω).</li>
                            <li>–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø–æ—è–≤–∏—Ç—Å—è –∞–¥—Ä–µ—Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Ñ–∞–π–ª.</li>
                            <li>–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ï—Å–ª–∏ –≤—ã –∑–∞–∫—Ä–æ–µ—Ç–µ –≤–∫–ª–∞–¥–∫—É –∏ –æ—Ç–∫—Ä–æ–µ—Ç–µ –µ–µ —Å–Ω–æ–≤–∞, –≤—ã —Å–º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å —Ç–æ–≥–æ –∂–µ –º–µ—Å—Ç–∞. –ö–Ω–æ–ø–∫–∞ üîÑ –≤ —à–∞–ø–∫–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞—á–∞—Ç—å –≤—Å–µ —Å–Ω–∞—á–∞–ª–∞, —É–¥–∞–ª–∏–≤ –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.</li>
                        </ol>
                    </div>
                `
            },
            { 
                icon: "üë§", title: "–î–∞–Ω–Ω—ã–µ –æ —Å–µ–±–µ", fields: [
                    { id: "region", label: "–†–µ–≥–∏–æ–Ω", tooltip: "–ü—Ä–∏–º–µ—Ä: –õ–∏–ø–µ—Ü–∫–∞—è –æ–±–ª–∞—Å—Ç—å", placeholder: "–£–∫–∞–∂–∏—Ç–µ –í–∞—à —Ä–µ–≥–∏–æ–Ω" },
                    { id: "fio",    label: "–§–ò–û –∑–∞–ø–æ–ª–Ω—è—é—â–µ–≥–æ", tooltip: "–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é", placeholder: "–£–∫–∞–∂–∏—Ç–µ –í–∞—à–µ –§–ò–û" }
                ]
            },
            { 
                icon: "‚ÑπÔ∏è", title: "–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ü–µ—Å—Å–µ", fields: [
                    { id: "process_name",        label: "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞", tooltip: "–£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, –æ—Ç—Ä–∞–∂–∞—é—â–µ–µ —Å—É—Ç—å", placeholder: "–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞" },
                    { id: "process_description", label: "–¶–µ–ª—å –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞", tooltip: "–î–∞–π—Ç–µ –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏ —Ü–µ–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞", placeholder: "–°—É—Ç—å –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞" },
                    { id: "process_group",       label: "–ü—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–∞", tooltip: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ (–±—é–¥–∂–µ—Ç, –∫–∞–¥—Ä—ã –∏ –¥—Ä.), –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ (–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏ –¥—Ä.), –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ (–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, –º–æ–ª–æ–¥–µ–∂–Ω—ã–µ –æ–±—å–µ–¥–∏–Ω–µ–Ω–∏—è –∏ –¥—Ä.), –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ (—Å–±–æ—Ä –∏ –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, –æ—Ü–µ–Ω–∫–∞), –°–æ—Ü–∏–∞–ª—å–Ω–æ-–∞–¥–∞–ø—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ (–∏–Ω–∫–ª—é–∑–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã, –ø—Ä–æ—Ñ. –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –∏ –¥—Ä.), –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ (IT, —Ä–∞–∑–≤–∏—Ç–∏–µ —Å—Ç–∞—Ä—Ç–∞–ø–æ–≤ –∏ –¥—Ä.)", type: "select",
                        options: ["–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ (–±—é–¥–∂–µ—Ç, –∫–∞–¥—Ä—ã –∏ –¥—Ä.)", "–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ (–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏ –¥—Ä.)", "–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ (–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, –º–æ–ª–æ–¥–µ–∂–Ω—ã–µ –æ–±—å–µ–¥–∏–Ω–µ–Ω–∏—è –∏ –¥—Ä.)", "–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ (—Å–±–æ—Ä –∏ –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, –æ—Ü–µ–Ω–∫–∞)", "–°–æ—Ü–∏–∞–ª—å–Ω–æ-–∞–¥–∞–ø—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ (–∏–Ω–∫–ª—é–∑–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã, –ø—Ä–æ—Ñ. –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –∏ –¥—Ä.)", "–ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ (IT, —Ä–∞–∑–≤–∏—Ç–∏–µ —Å—Ç–∞—Ä—Ç–∞–ø–æ–≤ –∏ –¥—Ä.)"] },
                    { id: "process_category",    label: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è", tooltip: "–£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ—Ü–µ—Å—Å–∞", type: "select",
                        options: ["–§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π","–†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–π","–ú—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π"] },
                    { id: "organization_type",   label: "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –ø—Ä–æ—Ü–µ—Å—Å–∞", tooltip: "–ö—Ç–æ –∏—Å–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å/–æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –ø—Ä–æ—Ü–µ—Å—Å–∞", type: "select",
                        options: ["–†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ä–≥–∞–Ω –≤–ª–∞—Å—Ç–∏","–ü–æ–¥–≤–µ–¥–æ–º—Å—Ç–≤–µ–Ω–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è"] },
                    { id: "regional_authority_name", label: "–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ä–≥–∞–Ω–∞ –≤–ª–∞—Å—Ç–∏", placeholder: "–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∞ –≤–ª–∞—Å—Ç–∏", type: 'text', conditional: true },
                    { id: "subordinate_org_name",  label: "–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–≤–µ–¥–æ–º—Å—Ç–≤–µ–Ω–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏", placeholder: "–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–≤–µ–¥–æ–º—Å—Ç–≤–µ–Ω–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏", type: 'text', conditional: true }
                ]
            },
            { 
                icon: "üîó", 
                title: "–°–≤—è–∑–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã", 
                stepDefinitionHtml: ` 
                    <p class="font-semibold text-gray-700 dark:text-gray-300">–°–≤—è–∑–∞–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å - —ç—Ç–æ –¥—Ä—É–≥–æ–π –ø—Ä–æ—Ü–µ—Å—Å, –∫–æ—Ç–æ—Ä—ã–π –∏–º–µ–µ—Ç –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω—É—é –≤–∑–∞–∏–º–æ—Å–≤—è–∑—å –∏–ª–∏ –≤–∑–∞–∏–º–æ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å —Å —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º—ã–º (–æ—Å–Ω–æ–≤–Ω—ã–º) –ø—Ä–æ—Ü–µ—Å—Å–æ–º.</p>
                    <ul class="list-disc list-inside mt-1 text-sm text-gray-600 dark:text-gray-400"></ul>
                    <p class="mt-2 text-sm text-gray-600 dark:text-gray-400"></p>
                `, 
                fields: [], 
                customRenderFunctionName: 'renderRelatedProcessesStepControls',
                maxRelatedProcesses: 5,
            },
            { 
                icon: "üë•", title: "–ó–∞–∫–∞–∑—á–∏–∫ –∏ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∞—Ç–µ–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞", fields: [
                    { id: "process_customer",  label: "–ó–∞–∫–∞–∑—á–∏–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞", tooltip: "–ó–∞–∫–∞–∑—á–∏–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ ‚Äî —ç—Ç–æ —Ä–æ–ª—å —Ç–æ–≥–æ, –∫—Ç–æ –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å, –∞ —Ç–∞–∫–∂–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –µ–≥–æ —Ü–µ–ª–∏ –∏ –∫–ª—é—á–µ–≤—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è", placeholder: "–ù–∞–ø–∏—à–∏—Ç–µ –¥–æ–ª–∂–Ω–æ—Å—Ç—å" },
                    { id: "process_client",    label: "–ë–ª–∞–≥–æ–ø–æ–ª—É—á–∞—Ç–µ–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞", tooltip: "–ö–æ–Ω–µ—á–Ω—ã–π –ø–æ–ª—É—á–∞—Ç–µ–ª—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞", placeholder: "–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è / –ø–æ–ª—É—á–∞—Ç–µ–ª—å" },
                    { id: "client_count",      label: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π (–≤ –≥–æ–¥)", tooltip: "–ë–ª–∞–≥–æ–ø–æ–ª—É—á–∞—Ç–µ–ª—å –ø—Ä–æ—Ü–µ—Å—Å–∞ ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ–ª—É—á–∞—Ç–µ–ª—å –∫–æ–Ω–µ—á–Ω–æ–π –≤—ã–≥–æ–¥—ã/–ø–æ–ª—å–∑—ã –æ—Ç –ø—Ä–æ—Ü–µ—Å—Å–∞", placeholder: "–ß–∏—Å–ª–æ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –≤ –≥–æ–¥", type: "number", min: 0 },
                    { id: "process_instances", label: "–≠–∫–∑–µ–º–ø–ª—è—Ä—ã –ø—Ä–æ—Ü–µ—Å—Å–∞ (–≤ –≥–æ–¥)", tooltip: "–ü—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π –ø—Ä–æ—Ü–µ—Å—Å–∞ –∑–∞ –≥–æ–¥", placeholder: "–ß–∏—Å–ª–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π / –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π", type: "number", min: 0 }
                ]
            },
            { 
                icon: "üìë", title: "–î–æ–∫—É–º–µ–Ω—Ç—ã, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –ö–ü–≠", fields: [
                    { id: "docs_in",        label: "–ò–Ω–∏—Ü–∏–∏—Ä—É—é—â–µ–µ —Å–æ–±—ã—Ç–∏–µ –Ω–∞ –≤—Ö–æ–¥–µ", tooltip: "–°–≤–µ–¥–µ–Ω–∏—è –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞", placeholder: "–ò–Ω–∏—Ü–∏–∏—Ä—É—é—â–µ–µ —Å–æ–±—ã—Ç–∏–µ/–¥–æ–∫—É–º–µ–Ω—Ç" },
                    { id: "result_out",     label: "–†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ –≤—ã—Ö–æ–¥–µ", tooltip: "–í—ã–≥–æ–¥–∞/—Ü–µ–Ω–Ω–æ—Å—Ç—å –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—É—á–∞—é—Ç—Å—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞", placeholder: "–ö–æ–Ω–µ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—Å–æ–±—ã—Ç–∏–µ/–¥–æ–∫—É–º–µ–Ω—Ç)" },
                    { id: "result_count",   label: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–≤ –≥–æ–¥)", tooltip: "–£–∫–∞–∂–∏—Ç–µ –≤ –µ–¥., —à—Ç.", placeholder: "–ß–∏—Å–ª–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–∑–∞ –ø—Ä–æ—à–ª—ã–π –≥–æ–¥)", type: "number", min: 0 },
                    { id: "control_points", label: "–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã", tooltip: "–ö–ª—é—á–µ–≤—ã–µ —ç—Ç–∞–ø—ã –∫–æ–Ω—Ç—Ä–æ–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞", placeholder: "–£–∫–∞–∂–∏—Ç–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ (—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏) " },
                    { id: "kpi_exists",     label: "–ù–∞–ª–∏—á–∏–µ –ö–ü–≠", tooltip: "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ª–∏ –∫–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏?", type: "select", options: ["–î–∞","–ù–µ—Ç"] },
                    { id: "kpi_details",    label: "–£–∫–∞–∂–∏—Ç–µ –ö–ü–≠", placeholder: "–ù–∞–∑–≤–∞–Ω–∏–µ –∏ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è", type: 'text', conditional: true },
                ]
            },
            { 
                icon: "üìä", title: "–û—Ç—á—ë—Ç—ã", fields: [
                    { id: "reports_generated", label: "–§–æ—Ä–º–∏—Ä—É–µ–º—ã–µ –æ—Ç—á—ë—Ç—ã", tooltip: "–£–∫–∞–∂–∏—Ç–µ –≤–∏–¥—ã –æ—Ç—á–µ—Ç–æ–≤. –ù–∞–ø—Ä–∏–º–µ—Ä: Excel, Word, –¥–∞—à–±–æ—Ä–¥", placeholder: "–§–æ—Ä–º–∞—Ç—ã –∏ –≤–∏–¥—ã –æ—Ç—á–µ—Ç–æ–≤" }
                ]
            },
            { 
                icon: "üíª", title: "–î–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏", fields: [
                    { id: "paper_count",    label: "–ë—É–º–∞–∂–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã (–≤ –≥–æ–¥)", tooltip: "–ü—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–≤–æ –±—É–º–∞–∂–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤", placeholder: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à—Ç—É–∫", type: "number", min: 0 },
                    { id: "digital_count",  label: "–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã (–≤ –≥–æ–¥)", tooltip: "–ü—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª-–≤–æ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–Ω–µ —Å–∫–∞–Ω-–∫–æ–ø–∏–π)", placeholder: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à—Ç—É–∫", type: "number", min: 0 },
                    { id: "scan_count",     label: "–°–∫–∞–Ω-–∫–æ–ø–∏–∏ (–≤ –≥–æ–¥)", tooltip: "–ü—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª-–≤–æ —Å–æ–∑–¥–∞–≤–∞–µ–º—ã—Ö —Å–∫–∞–Ω-–∫–æ–ø–∏–π", placeholder: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à—Ç—É–∫", type: "number", min: 0 },
                    { id: "info_systems",   label: "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞", tooltip: "–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ò–° (–ï–ü–ì–£, –°–≠–î, —Å–∞–π—Ç –≤–µ–¥–æ–º—Å—Ç–≤–∞ –∏ –¥—Ä.)", placeholder: "–ù–∞–∑–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º/–ø–ª–∞—Ç—Ñ–æ—Ä–º" },
                    { id: "applied_tech",   label: "–ü—Ä–∏–º–µ–Ω—è–µ–º—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏", tooltip: "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ", type: "checkboxGroup",
                        options: [ "–ú–∞–∫—Ä–æ—Å—ã","–†–æ–±–æ—Ç–∏–∑–∞—Ü–∏—è (RPA)","–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç", "–ù–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è"]
                    }
                ]
            }
        ];
        
        let currentStep = 0;
        let submissions = [];
        let formState = {}; 

        const progressBar = document.getElementById('progressBar');
        const stepTitleEl = document.getElementById('stepTitle');
        const formSteps = document.getElementById('formSteps');
        const stepDefinitionContainer = document.getElementById('stepDefinitionContainer');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const exportBtn = document.getElementById('exportBtn');
        const counterDisplay = document.getElementById('counterDisplay');
        const toastContainer = document.getElementById('toastContainer');
        const htmlEl = document.documentElement;
        const themeToggle = document.getElementById('themeToggle');
        const clearStorageBtn = document.getElementById('clearStorageBtn');
        const emailBlock = document.getElementById('email-block');

        const LS_FORM_STATE_KEY = 'surveyFormState_v3_full_content_FRESH'; 
        const LS_SUBMISSIONS_KEY = 'surveySubmissions_v3_full_content_FRESH';
        const LS_CURRENT_STEP_KEY = 'surveyCurrentStep_v3_full_content_FRESH';
        const LS_THEME_KEY = 'surveyTheme_v3_full_content_FRESH'; 

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded and parsed - Initializing FRESH state.'); 
            
            currentStep = STEP_GLOSSARY; 
            formState = { hasRelatedProcesses: null, relatedProcessesArray: [] }; 
            submissions = []; 
            
            console.log('Initial state FORCED: currentStep:', currentStep, 'formState:', JSON.parse(JSON.stringify(formState)), 'submissions:', submissions.length);
            
            applySavedTheme(); 
            themeToggle.addEventListener('click', toggleTheme);
            clearStorageBtn.addEventListener('click', clearLocalStorageAndReset); 
            prevBtn.addEventListener('click', handlePrevClick);
            nextBtn.addEventListener('click', handleNextClickOrAddProcess);
            exportBtn.addEventListener('click', exportToExcelHandler);
            document.addEventListener('keydown', handleGlobalKeyDown);
            
            renderAll(); 
            // updateCounter(); 
        });

        function renderAll() { 
            console.log('renderAll called. Current step:', currentStep);
            renderProgress(); 
            renderStep(); 
        }
        
        /*
        function loadStateFromLocalStorage() {
            const savedFormState = localStorage.getItem(LS_FORM_STATE_KEY);
            const savedSubmissions = localStorage.getItem(LS_SUBMISSIONS_KEY);
            const savedCurrentStep = localStorage.getItem(LS_CURRENT_STEP_KEY);

            if (savedFormState) formState = JSON.parse(savedFormState); else formState = {};
            if (savedSubmissions) submissions = JSON.parse(savedSubmissions); else submissions = [];
            
            if (formState.hasRelatedProcesses === undefined) formState.hasRelatedProcesses = null;
            if (!Array.isArray(formState.relatedProcessesArray)) formState.relatedProcessesArray = [];

            if (savedCurrentStep) currentStep = parseInt(savedCurrentStep, 10); else currentStep = 0;
            
            if (isNaN(currentStep) || currentStep < 0 || currentStep >= stepsData.length) {
                currentStep = 0;
            }
            console.log('Loaded from LocalStorage: currentStep:', currentStep, 'formState:', JSON.parse(JSON.stringify(formState)), 'submissions:', submissions.length);
            if(formState.organization_type) {
                console.log('organization_type from localStorage:', formState.organization_type);
            }
        }
        */

        function saveStateToLocalStorage() {
            localStorage.setItem(LS_FORM_STATE_KEY, JSON.stringify(formState));
            localStorage.setItem(LS_SUBMISSIONS_KEY, JSON.stringify(submissions));
            localStorage.setItem(LS_CURRENT_STEP_KEY, currentStep.toString());
        }

        function clearLocalStorageAndReset() {
            if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.")) {
                localStorage.removeItem(LS_FORM_STATE_KEY);
                localStorage.removeItem(LS_SUBMISSIONS_KEY);
                localStorage.removeItem(LS_CURRENT_STEP_KEY);
                
                currentStep = STEP_GLOSSARY; 
                formState = { hasRelatedProcesses: null, relatedProcessesArray: [] }; 
                submissions = []; 
                
                console.log('State reset by button: currentStep:', currentStep, 'formState:', JSON.parse(JSON.stringify(formState)));
                
                showToast("–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã. –ù–∞—á–Ω–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞.", "info");
                emailBlock.classList.add('hidden');
                renderAll(); 
                updateCounter();
            }
        }

        function applySavedTheme() {
            const savedTheme = localStorage.getItem(LS_THEME_KEY);
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const useDark = savedTheme === 'dark' || (!savedTheme && prefersDark);
            htmlEl.classList.toggle('dark', useDark);
            themeToggle.textContent = useDark ? '‚òÄÔ∏è' : 'üåô';
        }
        function toggleTheme() {
            const isDark = htmlEl.classList.toggle('dark');
            themeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem(LS_THEME_KEY, isDark ? 'dark' : 'light');
        }
        function handleGlobalKeyDown(event) {
            if (event.key === 'Escape') {
                const activeElement = document.activeElement;
                if (activeElement && activeElement.dataset.fieldIdForTip) {
                    toggleTip(activeElement.dataset.fieldIdForTip, false);
                } else { 
                    const openTooltips = document.querySelectorAll('[id^="tip-"]:not(.hidden)');
                    openTooltips.forEach(tip => {
                        const fieldId = tip.id.substring(4); 
                        toggleTip(fieldId, false);
                    });
                }
            }
        }
        
        function handleAppliedTechCheckboxChange(event) {
            console.log('handleAppliedTechCheckboxChange triggered by:', event.target.name, event.target.value, event.target.checked);
            if (event.target.type !== 'checkbox') return;

            const changedCheckbox = event.target;
            const fieldName = changedCheckbox.name; 
            const changedValue = changedCheckbox.value; 
            const isChecked = changedCheckbox.checked; 
            const notAppliedValue = "–ù–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è"; 

            if (fieldName === 'applied_tech') {
                const groupContainer = changedCheckbox.closest('div[id$="-checkbox-group"]'); 
                if (!groupContainer) {
                    console.error('Checkbox group container not found for applied_tech');
                    return; 
                }
                const allCheckboxes = groupContainer.querySelectorAll('input[type="checkbox"]');

                if (changedValue === notAppliedValue) {
                    if (isChecked) {
                        allCheckboxes.forEach(cb => {
                            if (cb !== changedCheckbox) {
                                cb.checked = false; 
                                cb.disabled = true; 
                            } else {
                                cb.disabled = false; 
                            }
                            const label = cb.closest('label');
                            if(label) {
                                label.classList.toggle('opacity-50', cb.disabled);
                                label.classList.toggle('cursor-not-allowed', cb.disabled);
                            }
                        });
                        formState[fieldName] = [notAppliedValue];
                    } else {
                        allCheckboxes.forEach(cb => {
                            cb.disabled = false;
                            const label = cb.closest('label');
                            if(label) label.classList.remove('opacity-50', 'cursor-not-allowed');
                        });
                        formState[fieldName] = (formState[fieldName] || []).filter(item => item !== notAppliedValue);
                    }
                } else { 
                    if (isChecked) {
                        allCheckboxes.forEach(cb => {
                            if (cb.value === notAppliedValue) {
                                cb.checked = false;
                                cb.disabled = true;
                            } else {
                                cb.disabled = false; 
                            }
                            const label = cb.closest('label');
                            if(label) {
                                label.classList.toggle('opacity-50', cb.disabled);
                                label.classList.toggle('cursor-not-allowed', cb.disabled);
                            }
                        });
                        let currentSelection = (formState[fieldName] || []).filter(item => item !== notAppliedValue);
                        if (!currentSelection.includes(changedValue)) {
                            currentSelection.push(changedValue);
                        }
                        formState[fieldName] = currentSelection;
                    } else {
                        formState[fieldName] = (formState[fieldName] || []).filter(item => item !== changedValue);
                        const anyOtherTechChecked = (formState[fieldName] || []).length > 0; 
                        allCheckboxes.forEach(cb => {
                            if (cb.value === notAppliedValue) {
                                cb.disabled = anyOtherTechChecked;
                                const label = cb.closest('label');
                                if(label) {
                                    label.classList.toggle('opacity-50', cb.disabled);
                                    label.classList.toggle('cursor-not-allowed', cb.disabled);
                                }
                            }
                        });
                    }
                }
                console.log('formState[applied_tech] after change:', formState[fieldName]);
                updateNav();
                saveStateToLocalStorage(); 
            } else { 
                console.warn('handleAppliedTechCheckboxChange called for unexpected fieldName:', fieldName);
                updateFormStateForGenericCheckbox(fieldName, changedValue, isChecked);
                updateNav();
                saveStateToLocalStorage(); 
            }
        }

        function updateFormStateForGenericCheckbox(fieldName, value, isChecked) {
            console.log('updateFormStateForGenericCheckbox:', fieldName, value, isChecked);
            if (!formState[fieldName] || !Array.isArray(formState[fieldName])) {
                formState[fieldName] = [];
            }
            if (isChecked) {
                if (!formState[fieldName].includes(value)) formState[fieldName].push(value);
            } else {
                formState[fieldName] = formState[fieldName].filter(item => item !== value);
            }
        }

        function handleKpiChange() {
            if (currentStep !== STEP_DOCS_RESULTS_KPI) return;
            const kpiExistsSelect = document.getElementById('kpi_exists');
            const kpiDetailsContainer = document.getElementById('container-kpi_details');
            if (!kpiExistsSelect || !kpiDetailsContainer) {
                console.warn('KPI elements not found for handleKpiChange');
                return;
            }
            const selectedValue = kpiExistsSelect.value;
            const kpiDetailsInput = document.getElementById('kpi_details');
            console.log('handleKpiChange - selectedValue:', selectedValue);
            if (selectedValue === "–î–∞") {
                kpiDetailsContainer.classList.remove('hidden');
            } else {
                kpiDetailsContainer.classList.add('hidden');
                if (kpiDetailsInput) kpiDetailsInput.value = '';
                delete formState['kpi_details'];
            }
            updateNav();
            saveStateToLocalStorage(); 
        }

        function handleOrganizationChange() {
            console.log('handleOrganizationChange called. Current step:', currentStep);
            if (currentStep !== STEP_PROCESS_MAIN_INFO) {
                console.log('handleOrganizationChange: Not on STEP_PROCESS_MAIN_INFO, returning.');
                return;
            }

            const orgTypeSelect = document.getElementById('organization_type');
            const regionalAuthorityContainer = document.getElementById('container-regional_authority_name');
            const subordinateOrgContainer = document.getElementById('container-subordinate_org_name');

            console.log('orgTypeSelect:', orgTypeSelect);
            console.log('regionalAuthorityContainer:', regionalAuthorityContainer);
            console.log('subordinateOrgContainer:', subordinateOrgContainer);

            if (!orgTypeSelect || !regionalAuthorityContainer || !subordinateOrgContainer) {
                console.error('One or more elements for organization change not found!');
                return;
            }

            const selectedValue = orgTypeSelect.value;
            console.log('Selected organization_type value:', `"${selectedValue}"`); 

            const regionalAuthorityInput = document.getElementById('regional_authority_name');
            const subordinateOrgInput = document.getElementById('subordinate_org_name');

            if (selectedValue === "–†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ä–≥–∞–Ω –≤–ª–∞—Å—Ç–∏") {
                console.log('Condition: selectedValue === "–†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ä–≥–∞–Ω –≤–ª–∞—Å—Ç–∏" is TRUE');
                regionalAuthorityContainer.classList.remove('hidden'); 
                subordinateOrgContainer.classList.add('hidden');    
                if (subordinateOrgInput) subordinateOrgInput.value = ''; 
                delete formState['subordinate_org_name']; 
            } else if (selectedValue === "–ü–æ–¥–≤–µ–¥–æ–º—Å—Ç–≤–µ–Ω–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è") {
                console.log('Condition: selectedValue === "–ü–æ–¥–≤–µ–¥–æ–º—Å—Ç–≤–µ–Ω–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è" is TRUE');
                regionalAuthorityContainer.classList.remove('hidden'); 
                subordinateOrgContainer.classList.remove('hidden'); 
            } else {
                console.log('Condition: No specific organization type selected (or empty value)');
                regionalAuthorityContainer.classList.add('hidden');    
                subordinateOrgContainer.classList.add('hidden');    
                if (regionalAuthorityInput) regionalAuthorityInput.value = '';
                if (subordinateOrgInput) subordinateOrgInput.value = '';
                delete formState['regional_authority_name'];
                delete formState['subordinate_org_name'];
            }
            console.log('regional_authority_name hidden:', regionalAuthorityContainer.classList.contains('hidden'));
            console.log('subordinate_org_name hidden:', subordinateOrgContainer.classList.contains('hidden'));
            updateNav();
            saveStateToLocalStorage(); 
        }


        function renderProgress() {
            progressBar.innerHTML = stepsData.map((step, i) => {
                const isDone = i < currentStep;
                const isCurrent = i === currentStep;
                let lineStateClass = isDone ? 'border-primary dark:border-accent' : 'border-gray-300 dark:border-gray-700';
                const iconBaseClasses = 'w-8 h-8 md:w-10 md:h-10 flex-shrink-0 flex items-center justify-center rounded-full text-sm font-medium transition-all duration-300 border-2';
                let iconStateClasses = 'bg-card dark:bg-gray-800 border-gray-400 dark:border-gray-600 text-gray-400 dark:text-gray-500';
                if (isCurrent) iconStateClasses = 'bg-accent text-white border-accent';
                else if (isDone) iconStateClasses = 'bg-primary text-white border-primary';
                const connectorHtml = (i < stepsData.length - 1) ? `<div class="flex-grow border-t-2 ${lineStateClass} self-center mx-1 transition-colors duration-300"></div>` : '';
                return `<span title="${step.title}" class="${iconBaseClasses} ${iconStateClasses}">${step.icon || (i + 1)}</span>${connectorHtml}`;
            }).join('');
        }
        function createFieldTooltipHtml(fieldId, fieldLabel, tooltipText) {
            if (!tooltipText) return '';
            return `
                <button type="button" aria-label="–ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è ${fieldLabel}" 
                        data-field-id-for-tip="${fieldId}" 
                        onclick="toggleTip(this.dataset.fieldIdForTip, true)" 
                        onblur="setTimeout(() => toggleTip(this.dataset.fieldIdForTip, false), 100)" 
                        class="absolute top-0 right-0 mt-1 text-gray-400 hover:text-primary dark:hover:text-blue-400 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-accent rounded-full p-0.5">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                </button>
                <div id="tip-${fieldId}" class="absolute top-full left-0 mt-1 p-3 bg-tooltip dark:bg-gray-700 rounded-xl2 text-sm text-gray-700 dark:text-gray-200 shadow-lg hidden z-20 max-w-xs border border-gray-200 dark:border-gray-600" role="tooltip" aria-hidden="true">
                    ${tooltipText}
                </div>`;
        }

        function renderStep() {
            console.log(`renderStep called for step: ${currentStep} - ${stepsData[currentStep]?.title}`);
            if (currentStep < 0 || currentStep >= stepsData.length) currentStep = 0;
            const stepConfig = stepsData[currentStep];
            const { title, fields, stepDefinitionHtml, customRenderFunctionName, maxRelatedProcesses } = stepConfig;
            stepTitleEl.textContent = title;
            stepDefinitionContainer.innerHTML = ''; 
            formSteps.innerHTML = ''; 
            if (stepDefinitionHtml) {
                const definitionElement = document.createElement('div');
                definitionElement.id = 'stepDefinitionContent';
                definitionElement.className = 'p-4 mb-6 bg-gray-50 dark:bg-gray-950 border border-gray-200 dark:border-gray-600 rounded-xl2 shadow-soft text-sm text-gray-700 dark:text-gray-300';
                definitionElement.innerHTML = stepDefinitionHtml;
                stepDefinitionContainer.appendChild(definitionElement);
            }
            if (customRenderFunctionName && typeof window[customRenderFunctionName] === 'function') {
                console.log(`Calling custom render function: ${customRenderFunctionName}`);
                window[customRenderFunctionName](formSteps, maxRelatedProcesses);
            } else if (fields && fields.length > 0) {
                formSteps.innerHTML = fields.map(f => {
                    if (!f || !f.id) return '';
                    const isConditional = f.conditional;
                    const hiddenClass = isConditional ? 'hidden' : '';
                    const wrapperTag = f.type === 'checkboxGroup' ? 'fieldset' : 'div';
                    const wrapperStart = `<${wrapperTag} id="container-${f.id}" class="flex flex-col relative space-y-1 ${hiddenClass}">`;
                    const wrapperEnd = `</${wrapperTag}>`;
                    let fieldHtml = '';
                    const value = formState[f.id] || (f.type === 'checkboxGroup' ? [] : ''); 
                    const commonInputClasses = "p-2.5 border border-gray-300 dark:border-gray-600 rounded-xl2 focus:ring-2 focus:ring-offset-0 focus:ring-primary focus:border-primary dark:focus:border-primary bg-card dark:bg-gray-800 dark:text-gray-100 w-full transition-shadow duration-150 ease-in-out shadow-sm hover:shadow-md focus:shadow-lg";
                    const labelClasses = "font-medium text-gray-700 dark:text-gray-300";
                    if (f.type === 'checkboxGroup') {
                        const checkboxesHtml = (f.options || []).map((option, index) => {
                        const checkboxId = `${f.id}-${index}`;
                        const currentValueArray = Array.isArray(value) ? value : []; 
                        const notAppliedValue = "–ù–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è";
                        const fieldName = f.id; 

                        let isChecked = currentValueArray.includes(option);
                        let isDisabled = false;
                        
                        if (fieldName === 'applied_tech') { 
                            const isNotAppliedSelected = currentValueArray.includes(notAppliedValue);
                            const anyTechSelected = currentValueArray.some(item => item !== notAppliedValue);

                            if (option === notAppliedValue) {
                                isDisabled = anyTechSelected; 
                            } else {
                                isDisabled = isNotAppliedSelected; 
                            }
                            if(isDisabled) isChecked = false; 
                        } 

                        const checkboxLabelClasses = `flex items-center space-x-2 cursor-pointer text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}`;
                        const inputClasses = `rounded border-gray-300 dark:border-gray-600 text-primary shadow-sm focus:ring-offset-0 focus:ring-primary/50 dark:bg-gray-700 ${isDisabled ? 'cursor-not-allowed' : ''}`;

                        return `
                                <label for="${checkboxId}" class="${checkboxLabelClasses}">
                                    <input type="checkbox" id="${checkboxId}" name="${f.id}" value="${option}"
                                           class="${inputClasses}"
                                           ${isChecked ? 'checked' : ''}
                                           ${isDisabled ? 'disabled' : ''}>
                                    <span>${option}</span>
                                </label>`;
                        }).join('');
                            fieldHtml = `<legend class="${labelClasses} mb-1">${f.label}</legend><div id="${f.id}-checkbox-group" class="relative mt-1 space-y-1 border border-gray-200 dark:border-gray-700 p-3 rounded-xl2 shadow-sm">${checkboxesHtml}</div>${createFieldTooltipHtml(f.id, f.label, f.tooltip)}`;
                    } else if (f.type === 'select') {
                            fieldHtml = `<label for="${f.id}" class="${labelClasses}">${f.label}</label><select id="${f.id}" name="${f.id}" aria-describedby="tip-${f.id}" class="${commonInputClasses} appearance-none"><option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>${(f.options || []).map(o => `<option value="${o}" ${value === o ? 'selected' : ''}>${o}</option>`).join('')}</select>${createFieldTooltipHtml(f.id, f.label, f.tooltip)}`;
                    } else { 
                            fieldHtml = `<label for="${f.id}" class="${labelClasses}">${f.label}</label><input id="${f.id}" name="${f.id}" type="${f.type || 'text'}" placeholder="${f.placeholder || ''}" value="${value}" ${(f.type ==='number' && f.min !== undefined) ? `min="${f.min}"` : ''} aria-describedby="tip-${f.id}" class="${commonInputClasses}"/>${createFieldTooltipHtml(f.id, f.label, f.tooltip)}`;
                    }
                    return wrapperStart + fieldHtml + wrapperEnd;
                }).join('');
                fields.forEach(f => {
                    if (!f || !f.id) return;
                    const el = document.getElementById(f.id);
                    if (f.type === 'checkboxGroup') {
                        const groupContainer = document.getElementById(`${f.id}-checkbox-group`);
                        if (groupContainer) {
                            if (f.id === 'applied_tech') {
                                console.log(`Attaching handleAppliedTechCheckboxChange to checkbox group: ${f.id}`);
                                groupContainer.addEventListener('change', handleAppliedTechCheckboxChange);
                            }
                        }
                    } else if (el) {
                        const eventType = (el.tagName === 'SELECT' || f.type === 'checkbox') ? 'change' : 'input';
                        el.addEventListener(eventType, onInput);
                        if (f.type === 'number') el.addEventListener('blur', validateNumericInputOnBlur);
                        
                        if (f.id === 'organization_type' && currentStep === STEP_PROCESS_MAIN_INFO) {
                            console.log('Attaching change listener to organization_type select:', el);
                            el.addEventListener('change', handleOrganizationChange);
                        }
                        if (f.id === 'kpi_exists' && currentStep === STEP_DOCS_RESULTS_KPI) {
                             console.log('Attaching change listener to kpi_exists select:', el);
                            el.addEventListener('change', handleKpiChange);
                        }
                    }
                });
            } else {
                if(!stepDefinitionHtml && !(customRenderFunctionName && typeof window[customRenderFunctionName] === 'function')) {
                    formSteps.innerHTML = '';
                }
            }

            if (currentStep === STEP_PROCESS_MAIN_INFO) {
                console.log('renderStep: Calling handleOrganizationChange for initial setup of STEP_PROCESS_MAIN_INFO.');
                handleOrganizationChange();
            }
            if (currentStep === STEP_DOCS_RESULTS_KPI) {
                console.log('renderStep: Calling handleKpiChange for initial setup of STEP_DOCS_RESULTS_KPI.');
                handleKpiChange();
            }
            updateNav(); 
        }
        
        function renderRelatedProcessesStepControls(container, maxProcesses) {
            console.log('renderRelatedProcessesStepControls called');
            container.innerHTML = ''; 
            if (formState.hasRelatedProcesses === undefined) formState.hasRelatedProcesses = null;
            if (!Array.isArray(formState.relatedProcessesArray)) formState.relatedProcessesArray = [];
            const docFragment = document.createDocumentFragment();
            const questionSection = document.createElement('div');
            questionSection.className = 'mb-6 p-4 border border-gray-200 dark:border-gray-700 rounded-xl2 shadow-sm';
            const questionP = document.createElement('p');
            questionP.className = 'font-medium text-gray-700 dark:text-gray-300 mb-3';
            questionP.textContent = '–ï—Å—Ç—å –ª–∏ —É –æ–ø–∏—Å—ã–≤–∞–µ–º–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã?';
            questionSection.appendChild(questionP);
            const radioGroup = document.createElement('div');
            radioGroup.className = 'flex items-center space-x-6';
            ['yes', 'no'].forEach(value => {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex items-center';
                const radioInput = document.createElement('input');
                radioInput.type = 'radio';
                radioInput.name = 'hasRelatedProcessesRadio';
                radioInput.id = `hasRelated_${value}`;
                radioInput.value = value;
                radioInput.checked = formState.hasRelatedProcesses === value;
                radioInput.className = 'h-4 w-4 text-primary border-gray-300 focus:ring-primary dark:bg-gray-700 dark:border-gray-600';
                radioInput.addEventListener('change', (e) => {
                    console.log('Related processes radio changed:', e.target.value);
                    formState.hasRelatedProcesses = e.target.value;
                    if (e.target.value === 'yes' && formState.relatedProcessesArray.length === 0) {
                        formState.relatedProcessesArray.push('');
                    }
                    renderRelatedProcessesStepControls(container, maxProcesses);
                    updateNav();
                    saveStateToLocalStorage(); 
                });
                const radioLabel = document.createElement('label');
                radioLabel.htmlFor = `hasRelated_${value}`;
                radioLabel.textContent = value === 'yes' ? '–î–∞, –µ—Å—Ç—å' : '–ù–µ—Ç';
                radioLabel.className = 'ml-2 text-sm font-medium text-gray-700 dark:text-gray-300 cursor-pointer';
                wrapper.appendChild(radioInput);
                wrapper.appendChild(radioLabel);
                radioGroup.appendChild(wrapper);
            });
            questionSection.appendChild(radioGroup);
            docFragment.appendChild(questionSection);

            if (formState.hasRelatedProcesses === 'yes') {
                const processesListSection = document.createElement('div');
                processesListSection.id = 'related-processes-inputs-container';
                processesListSection.className = 'space-y-3 mt-4';
                formState.relatedProcessesArray.forEach((processText, index) => {
                    const fieldWrapper = document.createElement('div');
                    fieldWrapper.className = 'flex items-center space-x-2';
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.placeholder = `–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ ${index + 1}`;
                    input.value = processText;
                    input.className = "flex-grow p-2.5 border border-gray-300 dark:border-gray-600 rounded-xl2 focus:ring-2 focus:ring-primary bg-card dark:bg-gray-800 dark:text-gray-100 shadow-sm";
                    input.dataset.index = index;
                    input.addEventListener('input', (e) => {
                        formState.relatedProcessesArray[index] = e.target.value;
                        updateNav(); 
                        saveStateToLocalStorage(); 
                    });
                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.setAttribute('aria-label', `–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å ${index + 1}`);
                    deleteBtn.title = `–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å ${index + 1}`;
                    deleteBtn.className = 'p-2 text-red-500 hover:text-red-700 hover:bg-red-100 dark:hover:bg-red-900/50 rounded-full transition-colors';
                    deleteBtn.innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>`;
                    deleteBtn.addEventListener('click', () => {
                        formState.relatedProcessesArray.splice(index, 1);
                        if (formState.relatedProcessesArray.length === 0 && formState.hasRelatedProcesses === 'yes') {
                            formState.relatedProcessesArray.push(''); 
                        }
                        renderRelatedProcessesStepControls(container, maxProcesses);
                        updateNav();
                        saveStateToLocalStorage(); 
                    });
                    fieldWrapper.appendChild(input);
                    fieldWrapper.appendChild(deleteBtn);
                    processesListSection.appendChild(fieldWrapper);
                });
                docFragment.appendChild(processesListSection);

                if (formState.relatedProcessesArray.length < maxProcesses) {
                    const addButton = document.createElement('button');
                    addButton.type = 'button';
                    addButton.textContent = '+ –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ –ø—Ä–æ—Ü–µ—Å—Å';
                    addButton.className = 'mt-4 px-4 py-2 text-sm bg-green-500 hover:bg-green-600 text-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2';
                    addButton.addEventListener('click', () => {
                        if (formState.relatedProcessesArray.length < maxProcesses) {
                            formState.relatedProcessesArray.push('');
                            renderRelatedProcessesStepControls(container, maxProcesses);
                            const listContainer = document.getElementById('related-processes-inputs-container');
                            if (listContainer) {
                                const inputs = listContainer.querySelectorAll('input[type="text"]');
                                if (inputs.length > 0) inputs[inputs.length - 1].focus();
                            }
                            updateNav();
                            saveStateToLocalStorage(); 
                        }
                    });
                    docFragment.appendChild(addButton);
                }
            }
            container.appendChild(docFragment);
        }

        function validateNumericInputOnBlur(event) {
            const el = event.target;
            if (el.type === 'number') validateSingleField(el.id, el.value);
        }

        function validateSingleField(fieldId, value) {
            const fieldConfig = stepsData[currentStep]?.fields.find(f => f.id === fieldId);
            const el = document.getElementById(fieldId);
            const labelEl = document.querySelector(`label[for='${fieldId}']`) || document.querySelector(`#container-${fieldId} legend`);
            if (!fieldConfig || (!el && fieldConfig.type !== 'checkboxGroup')) return {isValid: true}; 
            let isValid = true;
            const container = document.getElementById(`container-${fieldId}`);
            if (!container || !container.classList.contains('hidden')) {
                if (fieldConfig.type === 'checkboxGroup') {
                    isValid = Array.isArray(value) && value.length > 0;
                } else if (String(value).trim() === '') {
                    isValid = false;
                }
            }
            if (isValid && fieldConfig.type === 'number' && String(value).trim() !== '') {
                const numValue = parseFloat(value);
                const min = parseFloat(fieldConfig.min);
                if (isNaN(numValue)) {
                    isValid = false;
                } else if (min !== undefined && numValue < min) {
                    isValid = false;
                }
            }
            const targetElForError = el || (fieldConfig.type === 'checkboxGroup' ? document.getElementById(`${fieldId}-checkbox-group`) : null);
            if (targetElForError) targetElForError.classList.toggle('field-error', !isValid);
            if (labelEl) labelEl.classList.toggle('label-error', !isValid);
            return {isValid, fieldConfig}; 
        }

        function onInput(e) {
            const fieldId = e.target.id;
            let value = e.target.value;
            console.log(`onInput for fieldId: ${fieldId}, value: "${value}"`);

            const fieldConfig = stepsData[currentStep]?.fields.find(f => f.id === fieldId);
            if (fieldConfig) {
                formState[fieldId] = value; 
                const el = document.getElementById(fieldId);
                const labelEl = document.querySelector(`label[for='${fieldId}']`);
                if (el) el.classList.remove('field-error');
                if (labelEl) labelEl.classList.remove('label-error');
            } else {
                 console.warn(`onInput: No fieldConfig found for fieldId: ${fieldId}`);
            }
            updateNav();
            saveStateToLocalStorage(); 
        }
        
        function updateNav() {
            if (currentStep < 0 || currentStep >= stepsData.length) {
                console.warn('updateNav: currentStep is out of bounds:', currentStep);
                return;
            }
            const stepConfig = stepsData[currentStep];
            let isStepCurrentlyValid = true;

            if (stepConfig.customRenderFunctionName === 'renderRelatedProcessesStepControls' && currentStep === STEP_RELATED_PROCESSES) {
                if (formState.hasRelatedProcesses === null) {
                    isStepCurrentlyValid = false;
                } else if (formState.hasRelatedProcesses === 'yes') {
                    isStepCurrentlyValid = Array.isArray(formState.relatedProcessesArray) &&
                                           formState.relatedProcessesArray.length > 0 &&
                                           formState.relatedProcessesArray.some(proc => proc && proc.trim() !== '');
                } else { 
                    isStepCurrentlyValid = true;
                }
                 console.log('updateNav (Related Processes): isStepCurrentlyValid:', isStepCurrentlyValid, 'formState.hasRelatedProcesses:', formState.hasRelatedProcesses);
            } else if (stepConfig.fields && stepConfig.fields.length > 0) {
                for (const f of stepConfig.fields) {
                    const container = document.getElementById(`container-${f.id}`);
                    if (container && container.classList.contains('hidden')) continue;
                    const fieldElement = document.getElementById(f.id);
                    const valueToValidate = f.type === 'checkboxGroup' 
                        ? (formState[f.id] || []) 
                        : (fieldElement ? fieldElement.value : (formState[f.id] || ''));
                    
                    const { isValid } = validateSingleField(f.id, valueToValidate);
                    if (!isValid) { 
                        isStepCurrentlyValid = false; 
                        break; 
                    }
                }
            } else {
                isStepCurrentlyValid = true; 
            }
            
            nextBtn.disabled = !isStepCurrentlyValid;
            nextBtn.classList.toggle('opacity-50', !isStepCurrentlyValid);
            nextBtn.classList.toggle('cursor-not-allowed', !isStepCurrentlyValid);

            const isLastDataEntryStep = currentStep === STEP_WORKFLOW_TECH;
            if (isLastDataEntryStep) {
                nextBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å';
                const canExport = submissions.length > 0 || (isStepCurrentlyValid && formHasAnyData(formState));
                exportBtn.classList.toggle('hidden', !canExport);
            } else {
                nextBtn.textContent = '–î–∞–ª–µ–µ ‚Üí';
                exportBtn.classList.add('hidden');
            }
            prevBtn.disabled = currentStep === 0;
            prevBtn.classList.toggle('opacity-50', currentStep === 0);
            prevBtn.classList.toggle('cursor-not-allowed', currentStep === 0);
        }

        window.toggleTip = function(fieldId, show) {
            const tipElement = document.getElementById(`tip-${fieldId}`);
            const buttonEl = document.querySelector(`button[data-field-id-for-tip="${fieldId}"]`);
            if (tipElement) {
                tipElement.classList.toggle('hidden', !show);
                tipElement.setAttribute('aria-hidden', String(!show));
                if (show && buttonEl) buttonEl.focus();
            }
        }
        function saveCurrentStepDataToFormState() {
            console.log('saveCurrentStepDataToFormState called for step:', currentStep);
            const fields = stepsData[currentStep]?.fields;
            if (fields && fields.length > 0) { 
                fields.forEach(f => {
                    if (!f || !f.id) return;
                    const el = document.getElementById(f.id);
                    const container = document.getElementById(`container-${f.id}`);
                    if (container && container.classList.contains('hidden')) {
                        console.log(`Field ${f.id} is hidden, deleting from formState.`);
                        delete formState[f.id]; return;
                    }
                    if (f.type === 'checkboxGroup') { 
                        if (!formState[f.id]) formState[f.id] = []; 
                    }
                    else if (el) { 
                        formState[f.id] = el.value; 
                    }
                });
            }
             console.log('FormState after saveCurrentStepDataToFormState:', JSON.parse(JSON.stringify(formState)));
        }
        function handlePrevClick() {
            console.log('handlePrevClick. Current step before:', currentStep);
            if (currentStep === STEP_RELATED_PROCESSES) { 
                console.log('Prev on Related Processes step, data should be in formState.');
            }
            else { saveCurrentStepDataToFormState(); } 
            if (currentStep > 0) { currentStep--; renderAll(); }
        }

        function handleNextClickOrAddProcess() {
            console.log('handleNextClickOrAddProcess. Current step:', currentStep);
            if (currentStep === STEP_RELATED_PROCESSES) {
                if (formState.hasRelatedProcesses === 'yes' && Array.isArray(formState.relatedProcessesArray)) {
                    formState.relatedProcessesArray = formState.relatedProcessesArray.filter(proc => proc && proc.trim() !== '');
                } else if (formState.hasRelatedProcesses === 'no') {
                    formState.relatedProcessesArray = [];
                } else if (formState.hasRelatedProcesses === null) {
                    showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ, –µ—Å—Ç—å –ª–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã.', 'warning');
                     console.log('Next click on Related: hasRelatedProcesses is null.');
                    return; 
                }
            } else {
                saveCurrentStepDataToFormState(); 
            }

            updateNav(); 
            if (nextBtn.disabled) { 
                console.log('Next button is disabled. Validation failed.');
                const stepConfig = stepsData[currentStep];
                if (stepConfig.customRenderFunctionName === 'renderRelatedProcessesStepControls' && currentStep === STEP_RELATED_PROCESSES) {
                    if(formState.hasRelatedProcesses === null) showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ, –µ—Å—Ç—å –ª–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã.', 'warning');
                    else if(formState.hasRelatedProcesses === 'yes') showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö (—Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω).', 'warning');
                } else if (stepConfig.fields && stepConfig.fields.length > 0) {
                    let firstInvalidField = null;
                    for (const f of stepConfig.fields) {
                        const container = document.getElementById(`container-${f.id}`);
                        if (container && container.classList.contains('hidden')) continue;
                        const fieldElement = document.getElementById(f.id);
                        const valueToValidate = f.type === 'checkboxGroup' ? (formState[f.id] || []) : (fieldElement ? fieldElement.value : (formState[f.id] || ''));
                        const { isValid, fieldConfig: cfg } = validateSingleField(f.id, valueToValidate);
                        if(!isValid) { firstInvalidField = cfg; break; }
                    }
                    if(firstInvalidField) showToast(`–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ ¬´${firstInvalidField.label}¬ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.`, "warning");
                    else showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.', 'warning');
                }
                return;
            }
            console.log('Next button is enabled. Proceeding.');

            if (currentStep < STEP_WORKFLOW_TECH) {
                currentStep++;
                renderAll();
            } else { 
                setButtonLoadingState(nextBtn, true, "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...");
                setTimeout(() => { 
                    addProcess();
                    setButtonLoadingState(nextBtn, false, "–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å");
                }, 200);
            }
        }
        
        function formHasAnyData(dataObject) {
             if (!dataObject || typeof dataObject !== 'object') return false;
             const keys = Object.keys(dataObject);
             if (keys.length === 0) return false;
             let significantKeyCount = 0;
             for (const key in dataObject) {
                 if (key === 'hasRelatedProcesses') continue;
                 if (key === 'relatedProcessesArray' && (!Array.isArray(dataObject[key]) || dataObject[key].filter(p=>p.trim()!=='').length === 0)) continue;
                 if (key === 'region' && !dataObject[key]) continue;
                 if (key === 'fio' && !dataObject[key]) continue;
                 const value = dataObject[key];
                 if ((typeof value === 'string' && value.trim() !== '') ||
                     (typeof value === 'number' && !isNaN(value)) ||
                     (Array.isArray(value) && value.length > 0 && !(key === 'relatedProcessesArray' && value.filter(p=>p.trim()!=='').length === 0) )) { 
                     significantKeyCount++;
                 }
             }
             const hasData = significantKeyCount > 0;
             console.log('formHasAnyData result:', hasData, 'Significant keys:', significantKeyCount);
             return hasData;
        }
        
        function addProcess() {
            console.log('addProcess called. Current formState:', JSON.parse(JSON.stringify(formState)));
            if (formState.hasRelatedProcesses === 'yes' && Array.isArray(formState.relatedProcessesArray)) {
                formState.relatedProcessesArray = formState.relatedProcessesArray.filter(proc => proc && proc.trim() !== '');
                if (formState.relatedProcessesArray.length === 0) {
                    showToast('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å: –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ –Ω–∞–ª–∏—á–∏–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω.', 'warning');
                    return;
                }
            } else if (formState.hasRelatedProcesses === 'no' || formState.hasRelatedProcesses === null) {
                formState.relatedProcessesArray = [];
            }

            if (!formHasAnyData(formState)) {
                showToast("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ –ø—Ä–æ—Ü–µ—Å—Å–∞, –∫—Ä–æ–º–µ —Ä–µ–≥–∏–æ–Ω–∞ –∏ –§–ò–û.", "warning");
                return;
            }

            const processDataToAdd = { ...formState }; 
            if (!Array.isArray(processDataToAdd.relatedProcessesArray)) {
                processDataToAdd.relatedProcessesArray = [];
            }

            submissions.push(processDataToAdd);
            showToast(`–ü—Ä–æ—Ü–µ—Å—Å "${processDataToAdd.process_name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}" –¥–æ–±–∞–≤–ª–µ–Ω (${submissions.length})`, 'success');
            console.log('Process added. Submissions count:', submissions.length);

            const personalDataToKeep = {};
            if (stepsData[STEP_PERSONAL_DATA]?.fields) {
                stepsData[STEP_PERSONAL_DATA].fields.forEach(field => {
                    if (field?.id && processDataToAdd.hasOwnProperty(field.id)) {
                        personalDataToKeep[field.id] = processDataToAdd[field.id];
                    }
                });
            }
            formState = { ...personalDataToKeep, hasRelatedProcesses: null, relatedProcessesArray: [] }; 
            currentStep = (personalDataToKeep.region && personalDataToKeep.fio) ? STEP_PROCESS_MAIN_INFO : STEP_PERSONAL_DATA;
            console.log('Form state reset for new process. New currentStep:', currentStep, 'Kept personal data:', personalDataToKeep);
            emailBlock.classList.add('hidden');
            renderAll();
            // updateCounter();
            saveStateToLocalStorage(); 
        }

        function setButtonLoadingState(button, isLoading, loadingText = "–ó–∞–≥—Ä—É–∑–∫–∞...") {
            if (!button) return;
            if (isLoading) {
                button.disabled = true;
                button.dataset.originalText = button.textContent;
                button.innerHTML = loadingText; 
                button.classList.add('button-loading');
            } else {
                button.disabled = false;
                button.innerHTML = button.dataset.originalText || "–î–∞–ª–µ–µ ‚Üí";
                button.classList.remove('button-loading');
            }
        }
        function exportToExcelHandler() {
            setButtonLoadingState(exportBtn, true, "–≠–∫—Å–ø–æ—Ä—Ç...");
            setTimeout(() => { 
                exportToExcel();
                const originalText = exportBtn.dataset.originalText || "–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel";
                setButtonLoadingState(exportBtn, false, originalText);
            }, 200);
        }

        function exportToExcel() {
            console.log('exportToExcel called. Current step:', currentStep);
             if (currentStep !== STEP_RELATED_PROCESSES && stepsData[currentStep].fields && stepsData[currentStep].fields.length > 0){
                saveCurrentStepDataToFormState(); 
            } else if (currentStep === STEP_RELATED_PROCESSES) {
                 if (formState.hasRelatedProcesses === 'yes' && Array.isArray(formState.relatedProcessesArray)) {
                    formState.relatedProcessesArray = formState.relatedProcessesArray.filter(proc => proc && proc.trim() !== '');
                } else if (formState.hasRelatedProcesses === 'no' || formState.hasRelatedProcesses === null) {
                    formState.relatedProcessesArray = [];
                }
            }
            console.log('Form state before preparing export:', JSON.parse(JSON.stringify(formState)));

            const recordsToExport = [...submissions];
            let currentFormCanBeAddedToExport = false;

            if (formHasAnyData(formState)) {
                let isCurrentFormValidForExport = true; 
                const currentStepConfig = stepsData[currentStep];

                if (currentStepConfig.customRenderFunctionName === 'renderRelatedProcessesStepControls' && currentStep === STEP_RELATED_PROCESSES) {
                    if (formState.hasRelatedProcesses === 'yes' && (!Array.isArray(formState.relatedProcessesArray) || !formState.relatedProcessesArray.some(p => p.trim() !== ''))) {
                        isCurrentFormValidForExport = false; 
                    } else if (formState.hasRelatedProcesses === null) {
                         isCurrentFormValidForExport = false; 
                    }
                } else if (currentStepConfig.fields && currentStepConfig.fields.length > 0) { 
                    for (const f of currentStepConfig.fields) { 
                        const container = document.getElementById(`container-${f.id}`);
                        if (container && container.classList.contains('hidden')) continue; 
                        const valueToValidate = formState[f.id] || (f.type === 'checkboxGroup' ? [] : '');
                        if (!validateSingleField(f.id, valueToValidate).isValid) {
                            isCurrentFormValidForExport = false; 
                            console.log(`Export validation: Field ${f.id} is invalid.`);
                            break;
                        }
                    }
                }
                console.log('Export: isCurrentFormValidForExport based on current step data:', isCurrentFormValidForExport);

                if (isCurrentFormValidForExport) {
                    let isAlreadySubmitted = submissions.some(sub => JSON.stringify(sub) === JSON.stringify(formState));
                    if (!isAlreadySubmitted) {
                         currentFormCanBeAddedToExport = true;
                         console.log('Current form data is valid and not a duplicate, will be added to export.');
                    } else {
                        console.log('Current form data is a duplicate of an already submitted process.');
                    }
                }
            }
            
            if (currentFormCanBeAddedToExport) {
                recordsToExport.push({ ...formState });
            }

            if (recordsToExport.length === 0) {
                showToast("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.", "warning");
                console.log('No records to export.');
                return;
            }
            console.log('Total records for export:', recordsToExport.length);

            const allFieldsFromStepsConfig = stepsData.flatMap(step => {
                if (step.customRenderFunctionName === 'renderRelatedProcessesStepControls') {
                    return [{ id: 'relatedProcessesList_forExport', label: '–°–≤—è–∑–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã (—Å–ø–∏—Å–æ–∫)' }];
                }
                return step.fields || [];
            }).filter(f => f && f.id); 
            
            const uniqueFieldsConfig = [];
            const seenIds = new Set();
            for (const field of allFieldsFromStepsConfig) {
                if (!seenIds.has(field.id)) {
                    uniqueFieldsConfig.push(field);
                    seenIds.add(field.id);
                }
            }

            const headers = uniqueFieldsConfig.map(field => field.label);
            const fieldIds = uniqueFieldsConfig.map(field => field.id);

            const dataRows = recordsToExport.map(record => {
                return fieldIds.map(fieldId => {
                    let value;
                    if (fieldId === 'relatedProcessesList_forExport') {
                        value = Array.isArray(record.relatedProcessesArray) ? record.relatedProcessesArray.filter(p => p && p.trim() !== '').join('; ') : '';
                    } else {
                        value = record[fieldId];
                    }
                    if (Array.isArray(value) && fieldId !== 'relatedProcessesList_forExport') return value.join(', '); 
                    return (value !== undefined && value !== null) ? String(value) : '';
                });
            });

            const aoa = [headers, ...dataRows];
            try {
                const ws = XLSX.utils.aoa_to_sheet(aoa);
                if (aoa.length > 1 && headers.length > 0) { 
                    const colWidths = headers.map((h, i) => ({
                        wch: Math.max(
                            (h ? String(h).length : 0), 
                            ...dataRows.map(row => (row[i] ? String(row[i]).length : 0))
                        ) + 3 
                    }));
                    colWidths.forEach(col => { if (col.wch > 70) col.wch = 70; }); 
                    ws['!cols'] = colWidths;
                }
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "–î–∞–Ω–Ω—ã–µ –ü—Ä–æ—Ü–µ—Å—Å–æ–≤");
                const today = new Date().toISOString().slice(0, 10);
                const fileName = `–†–µ–µ—Å—Ç—Ä –ø—Ä–æ—Ü–µ—Å—Å–æ–≤_${today}.xlsx`;
                const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
                saveAs(new Blob([wbout], { type: "application/octet-stream" }), fileName);
                emailBlock.classList.remove('hidden');
                showToast("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!", 'success');
            } catch (error) {
                showToast("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ. " + error.message, "error");
                console.error('Error during Excel export:', error);
            }
        }

        function copyEmail() {
            const emailText = document.getElementById('email-text').textContent;
            navigator.clipboard.writeText(emailText)
                .then(() => showToast('Email —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!', 'success'))
                .catch(err => {
                    showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å Email. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é.', 'warning');
                    console.error('Failed to copy email:', err);
                });
        }
        function updateCounter() { counterDisplay.textContent = `–î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤: ${submissions.length}`; }
        function showToast(msg, type = 'info') {
            const t = document.createElement('div');
            t.textContent = msg;
            t.setAttribute('role', 'alert');
            t.setAttribute('aria-live', 'assertive'); 
            let typeClasses = 'bg-gray-700 dark:bg-gray-600 text-white';
            if (type === 'success') typeClasses = 'bg-green-600 dark:bg-green-700 text-white';
            else if (type === 'warning') typeClasses = 'bg-yellow-500 dark:bg-yellow-600 text-black dark:text-gray-900';
            else if (type === 'error') typeClasses = 'bg-red-600 dark:bg-red-700 text-white';
            t.className = `${typeClasses} px-4 py-3 rounded-xl2 shadow-lg opacity-0 transition-all duration-300 ease-out transform translate-y-2`;
            toastContainer.prepend(t);
            requestAnimationFrame(() => { requestAnimationFrame(() => { t.style.opacity = '1'; t.style.transform = 'translateY(0)'; }); });
            setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateY(10px)'; setTimeout(() => t.remove(), 350); }, type === 'warning' || type === 'error' ? 7000 : 5000);
        }
    </script>
</body>
</html>
